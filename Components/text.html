<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #app {
            max-width: 600px;
            margin: auto;
            text-align: center;
        }

        #gradeForm {
            margin-top: 20px;
        }

        #checkboxes {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            flex-direction: column;
            align-items: center;
        }

        .checkbox-label {
            margin: 5px;
        }

        button {
            margin: 10px;
        }

        #dataContainer {
            margin-top: 20px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .checkbox-label {
            margin-right: 10px;
        }
    </style>
</head>

<body>
    <div id="app">
        <h1>Grade Management</h1>
        <button id="addDataButton">Add Data</button>
        <div id="formContainer" style="display: none;">
            <form id="gradeForm">
                <div id="checkboxes">
                    <!-- Checkboxes will be dynamically added here -->
                </div>
                <button type="button" id="saveButton" style="display: none;">Save</button>
                <button type="button" id="cancelButton" style="display: none;">Cancel</button>
            </form>
        </div>
        <div>
            <label for="dateDropdown">Select Date:</label>
            <select id="dateDropdown">
                <!-- Options will be dynamically added here -->
            </select>
            <button id="showDataButton" style="display: none;">Show</button>
            <button id="cancelShowButton" style="display: none;">Cancel</button>
        </div>
        <div id="dataContainer">
            <!-- Data from Firestore will be displayed here -->
        </div>
    </div>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.5/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/9.6.5/firebase-firestore.js';

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC0jbQgXGYAvX2znLQLflVfXUjREwl3JyY",
            authDomain: "officetest-92e0d.firebaseapp.com",
            projectId: "officetest-92e0d",
            storageBucket: "officetest-92e0d.appspot.com",
            messagingSenderId: "435215452631",
            appId: "1:435215452631:web:75cd4ea4fb4d07b65be392"
        };


       // Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

document.addEventListener("DOMContentLoaded", function () {
    const addDataButton = document.getElementById("addDataButton");
    const formContainer = document.getElementById("formContainer");
    const gradeForm = document.getElementById("gradeForm");
    const checkboxes = document.getElementById("checkboxes");
    const saveButton = document.getElementById("saveButton");
    const cancelButton = document.getElementById("cancelButton");
    const dateDropdown = document.getElementById("dateDropdown");
    const showDataButton = document.getElementById("showDataButton");
    const cancelShowButton = document.getElementById("cancelShowButton");
    const dataContainer = document.getElementById("dataContainer");

    const grades = [
        { kit: 'Mega Kit', components: { Power: 1, Lamp: 1, Button: 1, 'Wire Tap': 1 } },
        { kit: 'AI Kit', components: { Power: 1, Lamp: 1, Button: 1, 'Wire Tap': 1 } },
        { kit: 'Wi-FI Kit', components: { Power: 1, Lamp: 1, Button: 1, 'Wire Tap': 1 } },
        { grade: 1, components: { Power: 1, Lamp: 1, Button: 1, 'Wire Tap': 1 } },
        { grade: 2, components: { Power: 1, Lamp: 1, Buzzer: 1, Dark: 1, 'Wire Tap': 1 } },
        { grade: 3, components: { Power: 1, 'Motor Driver': 1, Button: 1, Lamp: 1, 'Wire Tap': 1 } },
        { grade: 4, components: { Power: 1, 'Motor Driver': 1, Button: 1, Dark: 1, Invert: 1 } },
        { grade: 5, components: { Power: 1, 'Motor Driver': 1, Distance: 1, IR: 1, Invert: 1 } },
        { grade: 6, components: { Power: 1, 'Motor Driver': 1, Distance: 1, IR: 1, Invert: 1, Button: 1 } },
        { grade: 7, components: { Power: 1, 'Motor Driver': 1, AI: 1, Buzzer: 1, Lamp: 1, 'Wire Tap': 1 } },
        { grade: 8, components: { Buzzer: 1, Dark: 1, Distance: 1, IR: 1, Lamp: 1 } },
        { grade: 9, components: { Power: 1, 'Motor Driver': 1, Button: 1, Lamp: 1, 'Wire Tap': 1 } },
        { grade: 10, components: { Power: 10, Dark: 10, IR: 10, Motor: 10 } }
    ];

    grades.forEach(grade => {
        const container = document.createElement("div");
        container.className = "checkbox-container";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.name = "grade";
        checkbox.value = grade.grade || grade.kit;
        checkbox.addEventListener("change", handleCheckboxChange);

        const label = document.createElement("label");
        label.className = "checkbox-label";
        label.textContent = grade.grade ? `Grade ${grade.grade}` : grade.kit;

        const input = document.createElement("input");
        input.type = "number";
        input.name = `quantity${grade.grade ? grade.grade : grade.kit.replace(/\s+/g, '')}`;
        input.min = "1";
        input.style.display = "none";

        container.appendChild(checkbox);
        container.appendChild(label);
        container.appendChild(input);

        checkboxes.appendChild(container);
        checkboxes.appendChild(document.createElement("br")); // Add a line break after each container
    });

    addDataButton.addEventListener("click", function () {
        formContainer.style.display = "block";
        cancelButton.style.display = "inline-block";
    });

    cancelButton.addEventListener("click", function () {
        formContainer.style.display = "none";
        resetForm();
    });

    saveButton.addEventListener("click", async function () {
        const selectedGrades = Array.from(document.querySelectorAll("input[name='grade']:checked"))
            .map(checkbox => checkbox.value);

        if (selectedGrades.length > 0) {
            const gradeQuantities = selectedGrades.map(value => {
                const grade = grades.find(g => g.grade === parseInt(value) || g.kit === value);
                const inputName = `quantity${grade.grade ? grade.grade : grade.kit.replace(/\s+/g, '')}`;
                const inputElement = document.querySelector(`input[name='${inputName}']`);
                const inputQuantity = parseInt(inputElement.value);

                if (isNaN(inputQuantity) || inputQuantity <= 0) {
                    throw new Error(`Invalid quantity for ${grade.grade ? `Grade ${grade.grade}` : grade.kit}`);
                }

                const components = {};
                for (const [component, quantity] of Object.entries(grade.components)) {
                    components[component] = quantity * inputQuantity;
                }

                return {
                    grade: grade.grade || null,
                    kit: grade.kit || null,
                    quantity: inputQuantity,
                    components
                };
            });

            const data = {
                grades: gradeQuantities,
                aggregatedComponents: aggregateComponents(gradeQuantities), // Calculate aggregated components
                date: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, "grades"), data);
                alert("Data saved successfully!");
                formContainer.style.display = "none";
                resetForm();
                loadSavedData();
            } catch (error) {
                console.error("Error saving data: ", error);
                alert(`Error saving data: ${error.message}`);
            }
        } else {
            alert("Please select a grade and enter quantities.");
        }
    });

    function handleCheckboxChange(event) {
        const checkbox = event.target;
        const input = checkbox.nextElementSibling.nextElementSibling;
        if (checkbox.checked) {
            input.style.display = "inline-block";
        } else {
            input.style.display = "none";
        }

        const selectedGrades = document.querySelectorAll("input[name='grade']:checked");
        if (selectedGrades.length > 0) {
            saveButton.style.display = "inline-block";
            cancelButton.style.display = "inline-block";
        } else {
            saveButton.style.display = "none";
            cancelButton.style.display = "none";
        }
    }

    function resetForm() {
        document.querySelectorAll("input[name='grade']").forEach(checkbox => {
            checkbox.checked = false;
            checkbox.nextElementSibling.nextElementSibling.style.display = "none";
        });
    }

    async function loadSavedData() {
        try {
            const querySnapshot = await getDocs(collection(db, "grades"));
            dateDropdown.innerHTML = "";
            querySnapshot.forEach(doc => {
                const option = document.createElement("option");
                option.value = doc.id;
                option.textContent = new Date(doc.data().date).toLocaleString();
                dateDropdown.appendChild(option);
            });
        } catch (error) {
            console.error("Error loading data: ", error);
        }
    }

    function aggregateComponents(gradeQuantities) {
        const aggregatedComponents = {};

        // Aggregate quantities
        gradeQuantities.forEach(gq => {
            for (const [component, quantity] of Object.entries(gq.components)) {
                if (!aggregatedComponents[component]) {
                    aggregatedComponents[component] = 0;
                }
                aggregatedComponents[component] += quantity;
            }
        });

        return aggregatedComponents;
    }

    dateDropdown.addEventListener("change", function () {
        const selectedDateId = dateDropdown.value;
        if (selectedDateId) {
            showDataButton.style.display = "inline-block";
            cancelShowButton.style.display = "inline-block";
        } else {
            showDataButton.style.display = "none";
            cancelShowButton.style.display = "none";
        }
    });

    cancelShowButton.addEventListener("click", function () {
        dataContainer.innerHTML = ""; // Clear data container
        showDataButton.style.display = "none";
        cancelShowButton.style.display = "none";
    });

    showDataButton.addEventListener("click", async function () {
        const selectedDateId = dateDropdown.value;
        if (selectedDateId) {
            try {
                const docRef = doc(db, "grades", selectedDateId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    dataContainer.innerHTML = `
                        <p>Grades:</p>
                        ${data.grades.map(gq => `
                            <p>${gq.grade ? `Grade ${gq.grade}` : gq.kit}: ${gq.quantity} </p>
                            ${Object.entries(gq.components).map(([component, quantity]) => `
                                <p>${component}: ${quantity}</p>
                            `).join('')}
                        `).join('')}
                        
                        <p>Aggregated Component Quantities:</p>
                        ${Object.entries(data.aggregatedComponents).map(([component, totalQuantity]) => `
                            <p>${component} Total: ${totalQuantity}</p>
                        `).join('')}
                        
                        <p>Date: ${new Date(data.date).toLocaleString()}</p>
                    `;
                } else {
                    dataContainer.innerHTML = "No data found.";
                }
            } catch (error) {
                console.error("Error getting document: ", error);
            }
        }
    });

    loadSavedData();
});

  </script>
</body>

</html>